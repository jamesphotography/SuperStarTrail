# 进度预计时间改进

## 问题描述

用户反馈：预计时间只显示照片处理时间，没有包含间隔填充和视频生成的额外时间，导致进度条到 100% 后还需要等待一段时间才能完成。

## 原因分析

处理流程包含多个阶段：

### 1. 照片处理阶段 ⏱️ (可预测)
- 读取 RAW 文件
- 应用白平衡
- 星轨堆栈
- **时间**: 每张约 2-5 秒（取决于硬件）

### 2. 间隔填充阶段 ⏱️ (难以预测)
- 检测星轨中的间隔
- 使用插值算法填充
- **时间**: 20-60 秒（取决于间隔数量，可变性大）

### 3. 星迹延时视频生成 ⏱️ (可粗略估计)
- 从临时帧生成 MP4 视频
- 使用 OpenCV VideoWriter
- **时间**: 30-90 秒（取决于帧数，100 帧约 60 秒）

### 4. 银河延时视频生成 ⏱️ (可粗略估计)
- 从临时帧生成 MP4 视频
- **时间**: 60-120 秒（取决于帧数，100 帧约 90 秒）

### 为什么难以准确估计？

1. **间隔填充**:
   - 取决于用户拍摄时的实际间隔数量
   - 算法复杂度取决于间隔大小
   - 无法预先知道

2. **视频生成**:
   - 虽然帧数已知，但编码速度受 CPU 性能影响
   - 不同内容的压缩效率不同
   - 系统负载影响

3. **用户体验考虑**:
   - 给出不准确的预计时间反而会降低信任度
   - "还剩 30 秒" 实际需要 2 分钟 → 用户体验差

## 解决方案：方案 1 - 诚实提示

### 实现方式

在状态栏显示预计时间时，根据是否启用了额外功能，添加 "+ 后期处理" 提示：

```python
# 根据是否启用额外功能，添加提示
if self.enable_gap_filling or self.enable_timelapse or self.enable_simple_timelapse:
    status = f"⏳ 处理中 - 预计剩余: {remaining_str} + 后期处理"
else:
    status = f"⏳ 处理中 - 预计剩余: {remaining_str}"
self.status_message.emit(status)
```

### 显示效果

#### 场景 1: 仅星轨堆栈
```
状态栏: ⏳ 处理中 - 预计剩余: 2分30秒
```

#### 场景 2: 启用了间隔填充
```
状态栏: ⏳ 处理中 - 预计剩余: 2分30秒 + 后期处理
```

#### 场景 3: 启用了延时视频
```
状态栏: ⏳ 处理中 - 预计剩余: 2分30秒 + 后期处理
```

#### 场景 4: 启用了间隔填充 + 两个延时视频
```
状态栏: ⏳ 处理中 - 预计剩余: 2分30秒 + 后期处理
```

### 优势

1. ✅ **诚实透明** - 不给用户错误预期
2. ✅ **实现简单** - 只需一行判断
3. ✅ **通用性强** - 适用于所有场景
4. ✅ **不会误导** - 用户知道还有额外处理时间
5. ✅ **无需维护** - 不需要调整经验值

### 用户体验改进

**修改前**:
```
⏳ 处理中 - 预计剩余: 30秒
[进度条到 100%]
[用户等待 2 分钟...]  ← 困惑："为什么还没完成？"
```

**修改后**:
```
⏳ 处理中 - 预计剩余: 30秒 + 后期处理
[进度条到 100%]
⏳ [2/4] 间隔填充中...
⏳ [3/4] 生成星迹延时...
⏳ [4/4] 生成银河延时...
✅ 全部完成！
```

用户心理：
- ✅ "还有后期处理，那等待是正常的"
- ✅ 每个阶段都有明确的状态提示
- ✅ 知道软件在工作，不是卡住了

---

## 其他考虑过的方案

### ❌ 方案 2: 基于经验值估计

```python
extra_time = 0
if self.enable_gap_filling:
    extra_time += 30  # 间隔填充大约 30 秒
if self.enable_timelapse:
    extra_time += 60  # 星迹延时大约 1 分钟
if self.enable_simple_timelapse:
    extra_time += 90  # 银河延时大约 1.5 分钟
```

**缺点**:
- 不准确，可能误导用户
- 需要根据实际测试调整经验值
- 不同硬件差异大

### ❌ 方案 3: 动态计算视频编码时间

在视频生成过程中实时更新剩余时间

**缺点**:
- 实现复杂
- 视频编码速度波动大
- 收益不大

---

## 实际处理时间示例

以处理 100 张照片为例（MacBook Pro M1）:

| 阶段 | 时间 | 占比 |
|-----|------|------|
| 照片处理 | ~5 分钟 | 62.5% |
| 间隔填充 | ~30 秒 | 6.3% |
| 星迹延时 | ~1 分钟 | 12.5% |
| 银河延时 | ~1.5 分钟 | 18.7% |
| **总计** | **~8 分钟** | **100%** |

可以看到：
- 照片处理占主要时间（可预测）
- 后期处理占 37.5%（难以准确预测）

如果只显示照片处理时间（5 分钟），用户会以为还有 3 分钟不知道。

使用 "+ 后期处理" 提示后，用户心理预期正确。

---

## 修改的文件

- `src/ui/main_window.py` - 第 239-244 行

## 测试验证

- ✅ Python 语法检查通过
- ✅ 逻辑判断正确
- ✅ 不影响现有功能

---

## 未来可能的改进

如果以后想提供更精确的预估，可以考虑：

1. **历史数据学习**:
   - 记录每次处理的实际时间
   - 建立时间预测模型
   - 根据硬件和参数调整

2. **分阶段进度条**:
   - 照片处理: 0-70%
   - 间隔填充: 70-75%
   - 星迹延时: 75-85%
   - 银河延时: 85-100%

3. **实时编码进度**:
   - VideoWriter 提供编码进度回调
   - 更新剩余时间

但这些都需要更多开发和测试工作，目前的简单提示方案已经足够好。

---

## 总结

通过添加 "+ 后期处理" 提示，用户可以清楚地知道：
1. 预计剩余时间只是照片处理部分
2. 后续还有额外的处理步骤
3. 不会在进度条 100% 后感到困惑

这是一个简单、有效、诚实的解决方案。✅
