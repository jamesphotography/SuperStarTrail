# SuperStarTrail 使用指南

## 启动程序

### 方法 1: 命令行启动
```bash
cd /Users/jameszhenyu/PycharmProjects/SuperStarTrail
source .venv/bin/activate  # 如果虚拟环境未激活
python src/main.py
```

### 方法 2: PyCharm 运行
1. 打开 PyCharm
2. 右键点击 `src/main.py`
3. 选择 "Run 'main'"

---

## GUI 界面说明

### 启动日志输出

程序启动时会在控制台输出：
```
2025-10-12 20:53:49 - SuperStarTrail - INFO - 启动 SuperStarTrail...
2025-10-12 20:53:49 - SuperStarTrail - INFO - SuperStarTrail 启动完成
```

**注意**: 可能会看到这个警告（可以忽略，不影响使用）：
```
error messaging the mach port for IMKCFRunLoopWakeUpReliable
```
这是 macOS 系统的输入法框架警告，不是错误。

---

## 使用流程

### 第 1 步：选择文件

1. 点击左侧的 **"选择目录"** 按钮
2. 浏览到包含 RAW 文件的文件夹（例如：`/Users/jameszhenyu/Desktop/Mark Ma`）
3. 点击 "Open" 确认

**界面会显示**:
- 文件列表中会列出所有 RAW 文件
- 底部显示 "已选择 206 个文件"（根据实际数量）
- "开始合成" 按钮变为可用

---

### 第 2 步：配置参数

#### 堆栈模式（必选）
- **Lighten (星轨)** - 推荐用于星轨合成 ✨
- **Average (降噪)** - 用于降噪和平滑
- **Darken (去光污染)** - 去除光污染
- **Comet (彗星效果)** - 创建彗星尾迹效果

#### 白平衡（可选）
- **相机白平衡** - 使用相机记录的白平衡（推荐）
- **日光** - 使用日光白平衡
- **自动** - 自动计算白平衡

#### 图像对齐（可选）
- **启用图像对齐 (修正相机抖动)** - 使用特征检测对齐图像
  - ✅ **适用场景**: 三脚架轻微抖动、风吹、快门震动
  - ⏱️ **性能影响**: 每张图片增加约 0.5-1 秒处理时间
  - 🎯 **对齐算法**: 使用 ORB 特征检测 + RANSAC 配准
  - 📏 **最大偏移**: 50 像素（超过则使用原图）
  - ⚠️ **注意**: 如果三脚架完全稳定，可以不启用以节省时间

---

### 第 3 步：开始合成

1. 点击 **"开始合成"** 按钮

**控制台会输出详细日志**:
```
============================================================
开始星轨合成
文件数量: 206
堆栈模式: lighten
白平衡: camera
图像对齐: 启用
============================================================
[  1/206] 正在处理: Z9L_8639-2.NEF
[  1/206] 完成: Z9L_8639-2.NEF (1.99秒)
[  2/206] 正在处理: Z9L_8640-2.NEF
[  2/206] 完成: Z9L_8640-2.NEF (2.52秒)
[  3/206] 正在处理: Z9L_8641-2.NEF
对齐成功: 平移 (-2.3, 1.8) 像素, 内点: 156/200
...
更新预览 (5/206)
...
------------------------------------------------------------
✅ 处理完成!
总耗时: 428.00 秒
平均速度: 2.08 秒/张
============================================================
```

**GUI 界面会显示**:
- 🎯 **状态标签**:
  - "准备开始..." → "开始处理 206 张图片..."
  - "处理中 [5/206] - 预计剩余: 420秒"
  - "✅ 合成完成！"（绿色）

- 📊 **进度条**:
  - 显示格式：`24% (50/206)`
  - 实时更新百分比和进度

- 🖼️ **预览区**:
  - 每处理 5 张图片更新一次
  - 实时显示合成效果
  - 最后显示完整结果

---

### 第 4 步：保存结果

1. 处理完成后，点击 **"保存结果"** 按钮
2. 选择保存位置和文件名
3. 选择格式：
   - **TIFF** - 推荐，保留 16-bit 精度
   - **JPEG** - 8-bit，文件较小
   - **PNG** - 支持 16-bit

**保存成功提示**:
```
结果已保存到:
/path/to/star_trail.tiff
```

---

## 进度监控

### 控制台输出示例

**处理开始**:
```
============================================================
开始星轨合成
文件数量: 10
堆栈模式: lighten
白平衡: camera
============================================================
```

**处理过程**:
```
[  1/10] 正在处理: Z9L_8639-2.NEF
[  1/10] 完成: Z9L_8639-2.NEF (1.99秒)
[  2/10] 正在处理: Z9L_8640-2.NEF
[  2/10] 完成: Z9L_8640-2.NEF (2.52秒)
...
更新预览 (5/10)
...
```

**处理完成**:
```
------------------------------------------------------------
✅ 处理完成!
总耗时: 20.80 秒
平均速度: 2.08 秒/张
============================================================
```

### GUI 状态显示

| 状态 | 显示 | 颜色 |
|------|------|------|
| 就绪 | "就绪" | 蓝色 |
| 处理中 | "处理中 [50/206] - 预计剩余: 320秒" | 蓝色 |
| 完成 | "✅ 合成完成！" | 绿色 |
| 错误 | "❌ 处理失败" | 红色 |

### 进度条信息

- **格式**: `百分比% (当前/总数)`
- **示例**: `24% (50/206)`
- **更新频率**: 每处理一张图片

---

## 高级功能

### 图像对齐详解

**为什么需要图像对齐？**
- 即使使用三脚架，也可能因为以下原因导致图像轻微位移：
  - 快门震动
  - 风吹导致的抖动
  - 地面轻微震动
  - 三脚架结构松动

**对齐算法原理：**
1. 以第一张图片为参考
2. 使用 ORB 特征检测器找到关键点（2000 个特征点）
3. 在后续图片中匹配这些特征点
4. 使用 RANSAC 算法剔除异常匹配
5. 计算仿射变换矩阵（支持平移和轻微旋转）
6. 应用变换对齐图像

**对齐日志解读：**
```
对齐成功: 平移 (-2.3, 1.8) 像素, 内点: 156/200
```
- `平移 (-2.3, 1.8)`: X 方向左移 2.3 像素，Y 方向下移 1.8 像素
- `内点: 156/200`: 200 个最佳匹配点中，156 个通过 RANSAC 验证

**何时启用对齐？**
- ✅ **推荐启用**: 长焦镜头、大风天气、轻量三脚架、快门速度较慢
- ❌ **可以禁用**: 重型三脚架、无风、使用遥控快门、确认无抖动

**对齐失败怎么办？**
如果看到 `对齐失败` 警告：
- 程序会自动使用原图继续处理
- 可能原因：
  - 云层移动导致特征点变化
  - 曝光差异过大
  - 星轨过长导致特征点不匹配
- 对最终结果影响很小

### 停止处理

- 点击 **"停止"** 按钮可以随时中断处理
- 控制台会输出：`用户取消处理`

### 预计时间

程序会自动计算：
- **已用时间**: 基于已处理的图片
- **平均速度**: 秒/张
- **预计剩余**: 根据平均速度计算

示例：
```
处理中 [50/206] - 预计剩余: 320秒
```
表示：已处理 50 张，还需约 320 秒（5.3 分钟）

---

## 性能数据

### 基于真实测试（206 张 Nikon Z9 NEF）

| 项目 | 数据 |
|------|------|
| 单张处理时间 | 2.08 秒 |
| 10 张总耗时 | 20.8 秒 |
| 206 张预估 | ~7 分钟 |
| 内存占用 | < 500 MB |
| 输出文件大小 | ~5.4 GB (未压缩) |

### 优化建议

1. **减少文件数量**: 如果只需要效果预览，先用 10-20 张测试
2. **关闭其他程序**: 释放更多 CPU 和内存
3. **使用 SSD**: RAW 文件读取速度更快

---

## 常见问题

### Q1: 程序启动后看到警告信息

**警告信息**:
```
error messaging the mach port for IMKCFRunLoopWakeUpReliable
```

**解答**: 这是 macOS 系统的输入法框架警告，**不是错误**，可以忽略。程序已正常启动。

---

### Q2: 进度条不动？

**检查**:
1. 查看控制台是否有日志输出
2. 确认文件格式是否为 RAW（.nef/.cr2 等）
3. 检查文件是否可读

**解决**:
- 如果长时间无响应，点击"停止"后重试
- 查看控制台错误信息

---

### Q3: 预览不更新？

**原因**: 预览每 5 张图片更新一次

**正常情况**:
- 处理第 5 张时更新第一次
- 处理第 10 张时更新第二次
- 最后一张时一定会更新

---

### Q4: 保存失败？

**常见原因**:
1. 磁盘空间不足（需要 5+ GB）
2. 文件路径包含特殊字符
3. 没有写入权限

**解决**:
- 检查可用磁盘空间
- 选择简单的文件名和路径
- 确认目标目录有写权限

---

### Q5: 处理速度慢？

**影响因素**:
- RAW 文件大小（45.7 MP 的 Z9 文件较大）
- 电脑性能（CPU 速度）
- 磁盘 I/O 速度（机械硬盘 vs SSD）

**参考速度**:
- MacBook Pro (M1/M2): ~2 秒/张
- 旧款 Intel Mac: ~3-5 秒/张

---

## 快捷测试

### 测试 10 张图片

修改测试脚本快速验证：
```bash
python test_stacking.py  # 默认处理 10 张
```

### 处理全部文件

在 GUI 中：
1. 选择目录 `/Users/jameszhenyu/Desktop/Mark Ma`
2. 确认显示 206 个文件
3. 选择 "Lighten (星轨)" 模式
4. 点击 "开始合成"
5. 等待约 7 分钟
6. 保存结果

---

## 日志文件

### 查看详细日志

如果需要调试，可以重定向日志：
```bash
python src/main.py > startrail.log 2>&1
```

然后查看：
```bash
cat startrail.log
```

### 日志级别

默认显示 INFO 级别：
- INFO: 正常操作信息
- WARNING: 警告信息（用户取消等）
- ERROR: 错误信息

---

## 输出格式对比

| 格式 | 位深 | 文件大小 | 质量 | 用途 |
|------|------|----------|------|------|
| TIFF | 16-bit | 大 (~5GB) | 最高 | 后期处理 |
| PNG | 16-bit | 中 (~3GB) | 高 | 保存档案 |
| JPEG | 8-bit | 小 (~50MB) | 中 | 分享预览 |

**推荐**:
- 📸 **专业后期**: TIFF 16-bit
- 💾 **长期保存**: PNG 16-bit
- 🌐 **网络分享**: JPEG 高质量

---

## 完整工作流示例

### 场景：206 张 Nikon Z9 NEF 星轨合成

**步骤**:

1. **启动程序**
   ```bash
   python src/main.py
   ```

2. **选择文件**
   - 点击 "选择目录"
   - 选择 `/Users/jameszhenyu/Desktop/Mark Ma`
   - 确认 "已选择 206 个文件"

3. **配置参数**
   - 堆栈模式: **Lighten (星轨)**
   - 白平衡: **相机白平衡**

4. **开始处理**
   - 点击 "开始合成"
   - 观察控制台日志
   - 观察 GUI 进度条和状态

5. **监控进度**
   ```
   处理中 [50/206] - 预计剩余: 320秒
   ```

6. **预览更新**
   - 第 5 张时首次预览
   - 每 5 张更新一次
   - 第 206 张显示最终结果

7. **保存结果**
   - 点击 "保存结果"
   - 文件名: `star_trail_206_frames.tiff`
   - 格式: TIFF
   - 等待保存完成

8. **完成**
   - 状态显示: "✅ 合成完成！"
   - 总耗时: ~7 分钟
   - 输出: 5.4 GB TIFF 文件

---

## 技巧和建议

### 💡 处理前

1. **先测试小批量**: 用 10-20 张测试参数和效果
2. **检查磁盘空间**: 确保至少 10 GB 可用
3. **关闭省电模式**: 确保 CPU 全速运行

### 💡 处理中

1. **不要关闭终端**: 会看到详细进度
2. **观察预览**: 及时发现问题
3. **注意预计时间**: 合理安排

### 💡 处理后

1. **立即备份**: 避免数据丢失
2. **检查结果**: 在图像查看器中预览
3. **保留原片**: 可能需要重新处理

---

## 下一步

### 功能探索

1. 尝试不同的堆栈模式
2. 测试不同白平衡效果
3. 对比 TIFF vs JPEG 输出

### 进阶使用

- 查看 [PROJECT_SPEC.md](PROJECT_SPEC.md) 了解技术细节
- 查看 [TEST_REPORT.md](TEST_REPORT.md) 了解性能数据
- 参与开发和贡献代码

---

**帮助**: 如有问题，查看控制台日志或提交 Issue

**版本**: 0.1.0-alpha
**更新**: 2025-10-12
