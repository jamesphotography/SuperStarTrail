# 银河延时视频功能

## 功能概述

新增了**银河延时视频**功能，让用户可以直接将原始照片合成为延时视频，无需进行星轨堆栈处理。

## 功能特点

### 三种输出模式

现在用户可以选择以下输出：

1. **星轨图片** - 主要功能，合成星轨堆栈图像
2. **星迹延时视频** - 展示星轨形成过程（从第1张到第N张的堆栈过程）
3. **银河延时视频** ✨ - 直接将原始照片合成延时视频

### 银河延时视频的优势

- 🎬 **无堆栈处理** - 直接使用原始照片生成视频
- 🌌 **展示银河移动** - 适合展示银河移动、云层变化、星空移动、日出日落等
- ⚡ **处理速度快** - 在读取照片时同步保存帧，无额外处理时间
- 🎨 **高质量输出** - 4K (3840×2160) 分辨率，25 FPS

## 使用方法

1. 在参数面板中勾选 **"银河延时"** 选项
2. 选择照片并设置其他参数（白平衡等）
3. 点击"开始处理"

## 技术实现

### UI 更改

**ParametersPanel (`src/ui/panels/parameters_panel.py`)**
- 添加了 `check_enable_simple_timelapse` 复选框
- 新增 `is_simple_timelapse_enabled()` 方法

### 处理逻辑

**ProcessThread (`src/ui/main_window.py`)**

1. **初始化阶段**:
   ```python
   if self.enable_simple_timelapse:
       simple_timelapse_generator = TimelapseGenerator(
           output_path=simple_timelapse_path,
           fps=self.video_fps,
           resolution=(3840, 2160)
       )
   ```

2. **处理循环**:
   ```python
   img = processor.process(path, **self.raw_params)
   
   # 如果启用普通延时视频，添加此帧
   if simple_timelapse_generator:
       simple_timelapse_generator.add_frame(img)
   ```

3. **完成阶段**:
   ```python
   if self.enable_simple_timelapse:
       success = simple_timelapse_generator.generate_video(cleanup=True)
   ```

### 文件命名格式

```
MilkyWayTimelapse_{首文件名}-{尾文件名}_{白平衡}WB_{帧率}FPS.mp4
```

示例: `MilkyWayTimelapse_IMG_0001-IMG_0100_CameraWB_25FPS.mp4`

## 参数说明

- **分辨率**: 3840×2160 (4K)
- **帧率**: 25 FPS（默认，可在设置中修改）
- **编码**: H.264
- **质量**: 高质量 JPEG 帧 (质量90)

## 性能优化

- ✅ 帧保存与图片处理并行进行
- ✅ 使用临时目录缓存帧
- ✅ 支持 cleanup 自动清理临时文件
- ✅ 无额外等待时间（与星轨处理同时进行）

## 使用场景

1. **天文摄影延时**
   - 星空移动
   - 银河运动
   - 流星雨

2. **自然景观延时**
   - 云层变化
   - 日出日落
   - 天气变化

3. **城市景观延时**
   - 车流
   - 人流
   - 光轨（非堆栈）

## 与星轨延时视频的区别

| 特性 | 普通延时视频 | 星轨延时视频 |
|------|------------|------------|
| 输入 | 原始照片 | 星轨堆栈过程 |
| 处理 | 无堆栈 | 逐步堆栈 |
| 内容 | 展示场景变化 | 展示星轨形成 |
| 帧数 | = 照片数量 | = 照片数量 |
| 用途 | 通用延时 | 星轨专用 |

## 示例

假设有 100 张照片：

- **普通延时视频**: 100帧 = 4秒视频 (25 FPS)
  - 展示: 天空从时间 T1 到 T100 的变化
  
- **星轨延时视频**: 100帧 = 4秒视频 (25 FPS)
  - 展示: 星轨从 1张照片堆栈到 100张照片的过程

## 日志输出示例

```
============================================================
开始星轨合成
文件数量: 100
堆栈模式: Lighten
白平衡: camera
图像对齐: 禁用
间隔填充: 启用
星轨延时视频: 禁用
普通延时视频: 启用 (4K 25FPS)
============================================================

[001/100] 正在处理: IMG_0001.CR2
[001/100] 完成: IMG_0001.CR2 (3.52秒)
...

------------------------------------------------------------
正在生成普通延时视频...
------------------------------------------------------------
✅ 普通延时视频生成完成，耗时: 45.23 秒
视频保存至: SimpleTimelapse_IMG_0001-IMG_0100_CameraWB_25FPS.mp4
```

## 总结

这个新功能为用户提供了更多的创作选择，可以同时生成：
- ✅ 星轨堆栈图片 (TIFF)
- ✅ 星轨形成过程延时视频 (MP4)
- ✅ 原始场景延时视频 (MP4) ⭐ NEW

三种输出可以独立启用，互不影响，为用户提供最大的灵活性。
